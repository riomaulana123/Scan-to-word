<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart OCR Lens</title>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,Arial;
  background:linear-gradient(180deg,#f4f7fb,#dde7f3);
  margin:0;padding:12px
}
.container{max-width:760px;margin:auto}
h1{text-align:center;margin:10px 0}
.card{
  background:#fff;border-radius:16px;
  padding:14px;margin-bottom:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.1)
}
button{
  width:100%;padding:12px;
  border:none;border-radius:12px;
  font-size:15px;font-weight:600;
  margin-top:8px;cursor:pointer
}
.scan{background:#0d6efd;color:#fff}
.full{background:#198754;color:#fff}
.word{background:#6f42c1;color:#fff}
.pdf{background:#dc3545;color:#fff}
.reset{background:#adb5bd}
button:active{transform:scale(.97)}

#imageContainer{
  position:relative;background:#000;
  border-radius:12px;overflow:hidden;
  touch-action:none
}
#image{width:100%;display:block}
#selection{
  position:absolute;
  border:2px dashed #00e5ff;
  background:rgba(0,229,255,.25);
  display:none
}
#status{text-align:center;font-size:14px;margin-top:6px}
#editor{height:260px;border-radius:12px}
textarea{
  width:100%;height:90px;
  border-radius:10px;
  padding:10px;border:1px solid #ddd
}
select,input[type=file]{width:100%;padding:10px}
.footer{text-align:center;font-size:12px;color:#777}
</style>
</head>

<body>
<div class="container">

<h1>üì∏ Smart OCR Lens</h1>

<div class="card">
  <input type="file" accept="image/*" id="imageInput">
  <select id="lang">
    <option value="ind+eng">Indonesia + English</option>
    <option value="ind">Indonesia</option>
    <option value="eng">English</option>
  </select>
</div>

<div class="card">
  <div id="imageContainer">
    <img id="image">
    <div id="selection"></div>
  </div>
</div>

<div class="card">
  <button class="scan" onclick="scanArea()">üîç Scan Area</button>
  <button class="full" onclick="scanFull()">üìÑ Scan Full Image</button>
  <button class="word" onclick="exportWord()">‚¨áÔ∏è Download Word</button>
  <button class="pdf" onclick="exportPDF()">‚¨áÔ∏è Download PDF</button>
  <button class="reset" onclick="resetAll()">‚ôªÔ∏è Reset</button>
  <div id="status">‚è≥ Menyiapkan OCR engine‚Ä¶</div>
</div>

<div class="card">
  <textarea id="ocrResult" placeholder="Hasil OCR mentah..."></textarea>
</div>

<div class="card">
  <div id="editor"></div>
</div>

<div class="footer">
  Smart OCR Lens ‚Ä¢ Cepat ‚Ä¢ Akurat ‚Ä¢ Gratis
</div>

</div>

<script>
const img=document.getElementById("image");
const container=document.getElementById("imageContainer");
const selection=document.getElementById("selection");
const statusText=document.getElementById("status");
const ocrResult=document.getElementById("ocrResult");
const quill=new Quill('#editor',{theme:'snow'});
let worker,startX,startY,selecting=false;

(async()=>{
  worker=await Tesseract.createWorker({
    logger:m=>{
      if(m.status==="recognizing text"){
        statusText.innerText=`ü§ñ OCR ${Math.round(m.progress*100)}%`;
      }
    }
  });
  await worker.loadLanguage("ind+eng");
  await worker.initialize("ind+eng");
  statusText.innerText="‚úÖ OCR siap digunakan";
})();

imageInput.onchange=e=>{
  img.src=URL.createObjectURL(e.target.files[0]);
  statusText.innerText="üì∑ Gambar dimuat";
};

function getPos(e){
  const r=container.getBoundingClientRect();
  const p=e.touches?e.touches[0]:e;
  return{x:p.clientX-r.left,y:p.clientY-r.top};
}

container.onmousedown=container.ontouchstart=e=>{
  e.preventDefault();selecting=true;
  const p=getPos(e);startX=p.x;startY=p.y;
  selection.style.display="block";
};

container.onmousemove=container.ontouchmove=e=>{
  if(!selecting)return;
  const p=getPos(e);
  selection.style.left=Math.min(startX,p.x)+"px";
  selection.style.top=Math.min(startY,p.y)+"px";
  selection.style.width=Math.abs(p.x-startX)+"px";
  selection.style.height=Math.abs(p.y-startY)+"px";
};

container.onmouseup=container.ontouchend=()=>selecting=false;

/* ‚ö° PREPROCESS CEPAT */
function preprocessFast(){
  const maxW=1200;
  const scale=Math.min(1,maxW/img.naturalWidth);
  const c=document.createElement("canvas");
  c.width=img.naturalWidth*scale;
  c.height=img.naturalHeight*scale;
  const ctx=c.getContext("2d");
  ctx.drawImage(img,0,0,c.width,c.height);
  const d=ctx.getImageData(0,0,c.width,c.height);
  for(let i=0;i<d.data.length;i+=4){
    const g=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
    d.data[i]=d.data[i+1]=d.data[i+2]=g;
  }
  ctx.putImageData(d,0,0);
  return c;
}

/* ‚ö° SCAN FULL */
async function scanFull(){
  if(!img.src)return alert("Upload gambar dulu");
  statusText.innerText="‚ö° Menyiapkan gambar‚Ä¶";
  const canvas=preprocessFast();
  statusText.innerText="ü§ñ OCR berjalan‚Ä¶";
  const {data}=await worker.recognize(canvas,{
    tessedit_pageseg_mode:6
  });
  quill.insertText(quill.getLength(),data.text+"\n");
  ocrResult.value+=data.text+"\n";
  statusText.innerText="‚úÖ Scan selesai";
}

/* ‚ö° SCAN AREA */
async function scanArea(){
  if(selection.offsetWidth<10)return alert("Blok area dulu");
  statusText.innerText="‚ö° Scan area‚Ä¶";
  const sx=img.naturalWidth/img.clientWidth;
  const sy=img.naturalHeight/img.clientHeight;
  const x=selection.offsetLeft*sx;
  const y=selection.offsetTop*sy;
  const w=selection.offsetWidth*sx;
  const h=selection.offsetHeight*sy;
  const c=document.createElement("canvas");
  c.width=Math.min(w,800);
  c.height=h*(c.width/w);
  c.getContext("2d").drawImage(img,x,y,w,h,0,0,c.width,c.height);
  const {data}=await worker.recognize(c,{tessedit_pageseg_mode:11});
  quill.insertText(quill.getLength(),data.text+"\n");
  ocrResult.value+=data.text+"\n";
  statusText.innerText="‚úÖ Scan area selesai";
}

function exportWord(){
  const text=quill.getText().trim();
  if(!text)return alert("Teks kosong");
  const paras=text.split("\n").filter(p=>p.trim());
  const doc=new docx.Document({
    sections:[{children:paras.map(p=>new docx.Paragraph({
      children:[new docx.TextRun({text:p,font:"Times New Roman",size:24})]
    }))}]
  });
  docx.Packer.toBlob(doc).then(b=>saveAs(b,"hasil-ocr.docx"));
}

function exportPDF(){
  const {jsPDF}=window.jspdf;
  const text=quill.getText().trim();
  if(!text)return alert("Teks kosong");
  const pdf=new jsPDF();
  pdf.text(pdf.splitTextToSize(text,180),10,10);
  pdf.save("hasil-ocr.pdf");
}

function resetAll(){
  quill.setText("");
  ocrResult.value="";
  selection.style.display="none";
}
</script>

</body>
</html>
