<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart OCR Lens Pro</title>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- TinyMCE (WAJIB PAKAI API KEY) -->
<script src="https://cdn.tiny.cloud/1/API_KEY_KAMU/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:system-ui,Arial;background:#eef2f7;margin:0;padding:12px}
.container{max-width:900px;margin:auto}
.card{background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
h1{text-align:center}
#imageContainer{position:relative;border-radius:12px;overflow:hidden;background:#000;touch-action:none}
#image{width:100%;display:block}
#selection{position:absolute;border:2px dashed #00c3ff;background:rgba(0,195,255,.25);display:none}
button{width:100%;padding:12px;margin-top:6px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer}
.primary{background:#0d6efd;color:#fff}
.success{background:#198754;color:#fff}
.danger{background:#dc3545;color:#fff}
.gray{background:#6c757d;color:#fff}
button:disabled{opacity:.5}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
#status{text-align:center;font-size:14px;color:#555}
.footer{text-align:center;font-size:12px;color:#777}
</style>
</head>

<body>
<div class="container">

<h1>üì∏ Smart OCR Lens Pro</h1>

<div class="card">
<input type="file" accept="image/*" id="imageInput">
</div>

<div class="card">
<div id="imageContainer">
<img id="image">
<div id="selection"></div>
</div>
</div>

<div class="card">
<button class="primary" id="scanBtn" onclick="scanArea()" disabled>üîç Scan Area</button>
<div class="row">
<button class="success" onclick="downloadDOCX()">‚¨áÔ∏è Word</button>
<button class="danger" onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
<button class="gray" onclick="printDoc()">üñ®Ô∏è Print</button>
</div>
<div id="status">‚è≥ Menyiapkan OCR engine‚Ä¶</div>
</div>

<div class="card">
<textarea id="editor"></textarea>
</div>

<div class="footer">Scan ‚Üí Edit ‚Üí Download ‚Üí Print</div>

</div>

<script>
/* ===== EDITOR ===== */
tinymce.init({
  selector:'#editor',
  height:400,
  menubar:true,
  plugins:'lists table image link media code fullscreen',
  toolbar:'undo redo | fontfamily fontsize | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist | table image link | fullscreen',
  font_family_formats:'Times New Roman=times new roman;Arial=arial;Calibri=calibri;Verdana=verdana'
});

/* ===== OCR ===== */
const img=document.getElementById("image");
const container=document.getElementById("imageContainer");
const selection=document.getElementById("selection");
const scanBtn=document.getElementById("scanBtn");
const statusText=document.getElementById("status");
const imageInput=document.getElementById("imageInput");

let startX=0,startY=0,selecting=false;
let worker;

(async()=>{
  worker=await Tesseract.createWorker({
    logger:m=>{
      if(m.status==="recognizing text"){
        statusText.innerText=`‚è≥ OCR ${Math.round(m.progress*100)}%`;
      }
    }
  });
  await worker.loadLanguage("ind+eng");
  await worker.initialize("ind+eng");
  await worker.setParameters({
    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
  });
  statusText.innerText="‚úÖ OCR siap digunakan";
})();

imageInput.onchange=e=>{
  img.src=URL.createObjectURL(e.target.files[0]);
};

function getPos(e){
  const r=container.getBoundingClientRect();
  const p=e.touches?e.touches[0]:e;
  return{x:p.clientX-r.left,y:p.clientY-r.top};
}

container.addEventListener("mousedown",start);
container.addEventListener("touchstart",start);
function start(e){
  e.preventDefault();
  selecting=true;
  const p=getPos(e);
  startX=p.x;startY=p.y;
  selection.style.display="block";
  selection.style.left=startX+"px";
  selection.style.top=startY+"px";
  selection.style.width=0;
  selection.style.height=0;
}

container.addEventListener("mousemove",move);
container.addEventListener("touchmove",move);
function move(e){
  if(!selecting)return;
  const p=getPos(e);
  selection.style.left=Math.min(startX,p.x)+"px";
  selection.style.top=Math.min(startY,p.y)+"px";
  selection.style.width=Math.abs(p.x-startX)+"px";
  selection.style.height=Math.abs(p.y-startY)+"px";
}

container.addEventListener("mouseup",end);
container.addEventListener("touchend",end);
function end(){
  selecting=false;
  scanBtn.disabled=false;
}

async function scanArea(){
  if(selection.offsetWidth<20)return alert("Blok teks dulu");

  statusText.innerText="‚è≥ OCR berjalan, mohon tunggu‚Ä¶";
  scanBtn.disabled=true;

  const sx=img.naturalWidth/img.clientWidth;
  const sy=img.naturalHeight/img.clientHeight;
  const x=selection.offsetLeft*sx;
  const y=selection.offsetTop*sy;
  const w=selection.offsetWidth*sx;
  const h=selection.offsetHeight*sy;

  const c=document.createElement("canvas");
  const ctx=c.getContext("2d");

  const MAX=1200;
  let cw=w,ch=h;
  if(w>MAX||h>MAX){
    const scale=Math.min(MAX/w,MAX/h);
    cw=w*scale;ch=h*scale;
  }

  c.width=cw;c.height=ch;
  ctx.drawImage(img,x,y,w,h,0,0,cw,ch);

  const {data}=await worker.recognize(c);
  tinymce.activeEditor.insertContent(data.text.replace(/\n/g,"<br>"));

  statusText.innerText="‚úÖ Scan selesai";
  scanBtn.disabled=false;
}

/* ===== EXPORT ===== */
function downloadDOCX(){
  const text=tinymce.activeEditor.getContent({format:'text'});
  if(!text)return alert("Teks kosong");
  const paras=text.split("\n").filter(p=>p.trim());
  const doc=new docx.Document({
    sections:[{children:paras.map(p=>new docx.Paragraph({
      children:[new docx.TextRun({text:p,font:"Times New Roman",size:24})]
    }))}]
  });
  docx.Packer.toBlob(doc).then(b=>saveAs(b,"hasil-ocr.docx"));
}

function downloadPDF(){
  const {jsPDF}=window.jspdf;
  const text=tinymce.activeEditor.getContent({format:'text'});
  const pdf=new jsPDF();
  pdf.text(pdf.splitTextToSize(text,180),10,10);
  pdf.save("hasil-ocr.pdf");
}

function printDoc(){
  const c=tinymce.activeEditor.getContent();
  const w=window.open("");
  w.document.write(`
    <html><head><style>
    body{font-family:"Times New Roman";margin:2.5cm}
    </style></head><body>${c}
    <script>
    window.onload=function(){window.print();window.close();}
    <\/script></body></html>
  `);
  w.document.close();
}
</script>

</body>
</html>
