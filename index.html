<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Area OCR Cepat</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<style>
body { font-family: Arial; background:#f2f2f2; padding:10px }
h2 { text-align:center }
#imageContainer { position:relative; width:100%; background:#000; touch-action:none }
#image { width:100%; display:block }
#selection {
  position:absolute;
  border:2px dashed #00aaff;
  background:rgba(0,170,255,.25);
  display:none;
}
button,input { width:100%; padding:10px; margin-top:8px; font-size:16px }
textarea { width:100%; height:120px; margin-top:8px }
#status { margin-top:6px; font-size:14px }
</style>
</head>

<body>

<h2>üì∏ Area OCR (Cepat & Stabil)</h2>

<input type="file" accept="image/*" id="imageInput">

<div id="imageContainer">
  <img id="image">
  <div id="selection"></div>
</div>

<button onclick="scanArea()">üîç Scan Area Terpilih</button>
<p id="status">‚è≥ Menyiapkan OCR engine‚Ä¶</p>

<textarea id="ocrResult" placeholder="Hasil teks..."></textarea>

<h3>Editor</h3>
<div id="editor" style="height:200px;background:#fff"></div>

<script>
const img = document.getElementById("image");
const container = document.getElementById("imageContainer");
const selection = document.getElementById("selection");
const statusText = document.getElementById("status");
const ocrResult = document.getElementById("ocrResult");
const quill = new Quill('#editor', { theme:'snow' });

let startX=0, startY=0, selecting=false;
let worker;

// ===== INIT OCR SEKALI SAJA =====
(async () => {
  worker = await Tesseract.createWorker();
  await worker.loadLanguage("ind+eng");
  await worker.initialize("ind+eng");
  statusText.innerText = "‚úÖ OCR siap digunakan";
})();

// Load image
imageInput.onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
};

// Get position
function getPos(e){
  const r = container.getBoundingClientRect();
  const p = e.touches ? e.touches[0] : e;
  return { x:p.clientX-r.left, y:p.clientY-r.top };
}

// Start select
container.addEventListener("touchstart", start);
container.addEventListener("mousedown", start);
function start(e){
  e.preventDefault();
  selecting=true;
  const p=getPos(e);
  startX=p.x; startY=p.y;
  selection.style.display="block";
  selection.style.left=startX+"px";
  selection.style.top=startY+"px";
  selection.style.width=0;
  selection.style.height=0;
}

// Move
container.addEventListener("touchmove", move);
container.addEventListener("mousemove", move);
function move(e){
  if(!selecting) return;
  const p=getPos(e);
  selection.style.left=Math.min(startX,p.x)+"px";
  selection.style.top=Math.min(startY,p.y)+"px";
  selection.style.width=Math.abs(p.x-startX)+"px";
  selection.style.height=Math.abs(p.y-startY)+"px";
}

// End
container.addEventListener("touchend",()=>selecting=false);
container.addEventListener("mouseup",()=>selecting=false);

// ===== SCAN AREA (CEPAT) =====
async function scanArea(){
  if(selection.offsetWidth<10) return alert("Blok area dulu");

  statusText.innerText="‚è≥ Scan area‚Ä¶";

  const sx = img.naturalWidth / img.clientWidth;
  const sy = img.naturalHeight / img.clientHeight;

  const x = selection.offsetLeft*sx;
  const y = selection.offsetTop*sy;
  const w = selection.offsetWidth*sx;
  const h = selection.offsetHeight*sy;

  const c=document.createElement("canvas");
  c.width=w; c.height=h;
  c.getContext("2d").drawImage(img,x,y,w,h,0,0,w,h);

  const { data } = await worker.recognize(c);

  const text = data.text.trim();
  ocrResult.value += text+"\n";
  quill.insertText(quill.getLength(), text+"\n");

  statusText.innerText="‚úÖ Scan selesai";
}
</script>

</body>
</html>
