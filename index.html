<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Area OCR - Blok dari Gambar</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 10px;
}

h2 { text-align:center; }

#imageContainer {
  position: relative;
  width: 100%;
  background: #000;
  touch-action: none;
}

#image {
  width: 100%;
  display: block;
}

#selection {
  position: absolute;
  border: 2px dashed #00aaff;
  background: rgba(0,170,255,0.25);
  display: none;
}

button, input {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}

textarea {
  width: 100%;
  height: 120px;
  margin-top: 8px;
}

#status {
  margin-top: 6px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>üì∏ Area OCR (Blok Langsung dari Gambar)</h2>

<input type="file" accept="image/*" id="imageInput">

<div id="imageContainer">
  <img id="image">
  <div id="selection"></div>
</div>

<button onclick="scanArea()">üîç Scan Area Terpilih</button>

<p id="status"></p>

<textarea id="ocrResult" placeholder="Hasil teks dari area..."></textarea>

<h3>Editor</h3>
<div id="editor" style="height:200px;background:#fff;"></div>

<script>
const imageInput = document.getElementById("imageInput");
const img = document.getElementById("image");
const container = document.getElementById("imageContainer");
const selection = document.getElementById("selection");
const statusText = document.getElementById("status");
const ocrResult = document.getElementById("ocrResult");

const quill = new Quill('#editor', { theme: 'snow' });

let startX = 0, startY = 0;
let selecting = false;

// Load image
imageInput.onchange = e => {
  img.src = URL.createObjectURL(e.target.files[0]);
};

// Convert touch / mouse
function getPos(e) {
  const rect = container.getBoundingClientRect();
  if (e.touches) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  }
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

// START
container.addEventListener("mousedown", startSelect);
container.addEventListener("touchstart", startSelect);

function startSelect(e) {
  e.preventDefault();
  selecting = true;
  const pos = getPos(e);
  startX = pos.x;
  startY = pos.y;

  selection.style.left = startX + "px";
  selection.style.top = startY + "px";
  selection.style.width = "0px";
  selection.style.height = "0px";
  selection.style.display = "block";
}

// MOVE
container.addEventListener("mousemove", moveSelect);
container.addEventListener("touchmove", moveSelect);

function moveSelect(e) {
  if (!selecting) return;
  const pos = getPos(e);

  const w = pos.x - startX;
  const h = pos.y - startY;

  selection.style.width = Math.abs(w) + "px";
  selection.style.height = Math.abs(h) + "px";
  selection.style.left = Math.min(startX, pos.x) + "px";
  selection.style.top = Math.min(startY, pos.y) + "px";
}

// END
container.addEventListener("mouseup", endSelect);
container.addEventListener("touchend", endSelect);

function endSelect() {
  selecting = false;
}

// OCR
async function scanArea() {
  if (selection.offsetWidth < 10 || selection.offsetHeight < 10) {
    alert("Blok area teks dulu");
    return;
  }

  statusText.innerText = "‚è≥ OCR area diproses...";

  const scaleX = img.naturalWidth / img.clientWidth;
  const scaleY = img.naturalHeight / img.clientHeight;

  const x = selection.offsetLeft * scaleX;
  const y = selection.offsetTop * scaleY;
  const w = selection.offsetWidth * scaleX;
  const h = selection.offsetHeight * scaleY;

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  canvas.getContext("2d").drawImage(img, x, y, w, h, 0, 0, w, h);

  const worker = await Tesseract.createWorker({
    logger: m => statusText.innerText = `‚è≥ ${Math.round(m.progress * 100)}%`
  });

  await worker.loadLanguage("ind+eng");
  await worker.initialize("ind+eng");

  const { data } = await worker.recognize(canvas);

  ocrResult.value += data.text.trim() + "\n";
  quill.insertText(quill.getLength(), data.text.trim() + "\n");

  await worker.terminate();
  statusText.innerText = "‚úÖ Area berhasil di-scan";
}
</script>

</body>
</html>
