<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart OCR Lens</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f6fb;
  margin: 0;
  padding: 12px;
}

h2 {
  text-align: center;
}

.container {
  max-width: 480px;
  margin: auto;
}

.preview-wrapper {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid #4f8cff;
}

#previewImage {
  width: 100%;
  display: block;
}

#selectBox {
  position: absolute;
  border: 2px dashed #00e5ff;
  background: rgba(0,229,255,0.15);
  display: none;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border: none;
  border-radius: 12px;
  background: #4f8cff;
  color: white;
  font-size: 16px;
}

textarea {
  width: 100%;
  min-height: 160px;
  margin-top: 12px;
  border-radius: 12px;
  padding: 12px;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.5;
}

#status {
  text-align: center;
  margin-top: 8px;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="container">

<h2>üì∏ Smart OCR Lens</h2>

<input type="file" accept="image/*" onchange="loadImage(event)">

<div class="preview-wrapper">
  <img id="previewImage">
  <div id="selectBox"></div>
</div>

<button onclick="scanArea()">üîç Scan Area</button>

<div id="status"></div>

<textarea id="result" placeholder="Hasil OCR muncul di sini..."></textarea>

</div>

<script>
let startX, startY, endX, endY;
let selectedArea = null;
const img = document.getElementById("previewImage");
const box = document.getElementById("selectBox");

function loadImage(e) {
  img.src = URL.createObjectURL(e.target.files[0]);
}

img.addEventListener("touchstart", e => {
  const r = img.getBoundingClientRect();
  startX = e.touches[0].clientX - r.left;
  startY = e.touches[0].clientY - r.top;
  box.style.display = "block";
});

img.addEventListener("touchmove", e => {
  const r = img.getBoundingClientRect();
  endX = e.touches[0].clientX - r.left;
  endY = e.touches[0].clientY - r.top;

  box.style.left = Math.min(startX, endX) + "px";
  box.style.top = Math.min(startY, endY) + "px";
  box.style.width = Math.abs(endX - startX) + "px";
  box.style.height = Math.abs(endY - startY) + "px";
});

img.addEventListener("touchend", () => {
  selectedArea = {
    x: Math.min(startX, endX),
    y: Math.min(startY, endY),
    width: Math.abs(endX - startX),
    height: Math.abs(endY - startY)
  };
});

async function scanArea() {
  if (!selectedArea) {
    alert("Blok area teks dulu");
    return;
  }

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const scaleX = img.naturalWidth / img.clientWidth;
  const scaleY = img.naturalHeight / img.clientHeight;

  canvas.width = selectedArea.width * scaleX;
  canvas.height = selectedArea.height * scaleY;

  ctx.drawImage(
    img,
    selectedArea.x * scaleX,
    selectedArea.y * scaleY,
    canvas.width,
    canvas.height,
    0, 0,
    canvas.width,
    canvas.height
  );

  // === HANDWRITING BOOST ===
  let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let d = imgData.data;

  for (let i = 0; i < d.length; i += 4) {
    let gray = d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11;
    let bw = gray > 140 ? 255 : 0;
    d[i] = d[i+1] = d[i+2] = bw;
  }

  ctx.putImageData(imgData, 0, 0);

  document.getElementById("status").innerText = "‚è≥ OCR diproses...";

  const { data } = await Tesseract.recognize(canvas, "ind+eng", {
    tessedit_pageseg_mode: 6,
    user_defined_dpi: 300
  });

  document.getElementById("result").value =
    data.text
      .replace(/\n{3,}/g,"\n\n")
      .replace(/[^\S\r\n]{2,}/g," ");

  document.getElementById("status").innerText = "‚úÖ Selesai";
}
</script>
</body>
</html>
